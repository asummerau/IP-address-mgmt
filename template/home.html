<!DOCTYPE html>
<html>
<head>
    <title>IP Address Table</title>
    <style>
        table {
            border-collapse: collapse;
            width: 90%;
        }

        th, td {
            padding: 8px;
            border-bottom: 1px solid #DDD;
        }
        tr:hover {background-color: #D6EEEE;}

        th {
            text-align: left;
        }

        /* Apply background color to the first row (excluding headers row) */
        tbody tr:first-child {
            background-color: rgba(128, 128, 128, 0.5);
            pointer-events: none; /* Disable pointer events */
        }

        /* Apply background color to the last row */
        tbody tr:last-child {
            background-color: rgba(128, 128, 128, 0.5);
            pointer-events: none; /* Disable pointer events */
        }

        /* Reset background color for the last row's first column */
        tbody tr:last-child td:first-child {
            background-color: transparent;
        }

        input[type="text"] {
            width: 40%;
            padding: 6px 10px;
            border: 1px solid #CCC;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Gray out and disable input fields and checkboxes in the first and last rows */
        tbody tr:first-child input[type="text"],
        tbody tr:last-child input[type="text"],
        tbody tr:first-child input[type="checkbox"],
        tbody tr:last-child input[type="checkbox"] {
            background-color: #DDD;
            color: #888;
            pointer-events: none;
        }

        tr.checked-row {
            background-color: rgba(255, 0, 0, 0.2);
        }

        tr.loaded-row {
            background-color: rgba(255, 0, 0, 0.2);
        }

        .save-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: #FFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Choose a Subnet:</h1>

    <select id="subnet-select" onchange="loadIPAddresses()">
        <option value="">-- Select a Subnet --</option>
        {% for subnet in av_subnets %}
        <option value="{{ subnet }}">{{ subnet }}</option>
        {% endfor %}
    </select>

    <div id="save-button-container" style="display: none;"> <!-- Initially hide the save button -->
        <button onclick="saveData()" class="save-button">Save</button>
    </div>

    <div id="ip-addresses-table-container">
        <!-- The IP addresses table will be loaded here -->
    </div>

    <script>
        function loadIPAddresses() {
            var subnet = document.getElementById('subnet-select').value;
                
            if (subnet) {
                var tableHtml = '<h2>IP Addresses in Subnet: ' + subnet + '</h2>';
                tableHtml += '<table>';
                tableHtml += '<thead><tr><th>IP Address</th><th>Comment</th><th>In Use</th></tr></thead>';
                tableHtml += '<tbody>';

                // Remove the following line:
                // var df = {{ df | tojson }};

                // Retrieve the data from the backend using AJAX, fetch, or any other method
                // Replace the URL below with the endpoint URL to fetch the data
                var url = '/getIPAddresses?subnet=' + subnet;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        var df = data; // Assuming the response is in the format of your previous data

                        for (var i = 0; i < df.length; i++) {
                            var row = df[i];
                            if (row.subnet == subnet) {
                                tableHtml += '<tr';
                                if (row.in_use) {
                                    tableHtml += ' class="checked-row"';
                                }
                                tableHtml += '>';
                                tableHtml += '<td>' + row.ip_address + '</td>';
                                if (i === 0 || i === df.length - 1) {
                                    tableHtml += '<td><input type="text" id="comment_' + i + '" value="' + (row.comment ? row.comment : '') + '" readonly></td>';
                                    tableHtml += '<td><input type="checkbox" id="in_use_' + i + '" ' + (row.in_use ? 'checked' : '') + ' readonly></td>';
                                } else {
                                    tableHtml += '<td><input type="text" id="comment_' + i + '" value="' + (row.comment ? row.comment : '') + '"></td>';
                                    tableHtml += '<td><input type="checkbox" id="in_use_' + i + '" ' + (row.in_use ? 'checked' : '') + ' onchange="handleCheckboxChange(this, this.parentNode.parentNode)"></td>';
                                }
                                tableHtml += '</tr>';
                            }
                        }

                        tableHtml += '</tbody>';
                        tableHtml += '</table>';

                        document.getElementById('ip-addresses-table-container').innerHTML = tableHtml;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Handle the error condition
                    });
                document.getElementById('save-button-container').style.display = 'block';

            } else {
                document.getElementById('ip-addresses-table-container').innerHTML = '';
                document.getElementById('save-button-container').style.display = 'none';

            }
        }

        
        function saveData() {
            var subnet = document.getElementById('subnet-select').value;

            if (subnet) {
                var df = []; // Empty array to store the updated data
                df.push({'selectected_subnet': subnet})
                var rows = document.querySelectorAll('#ip-addresses-table-container table tbody tr');

                rows.forEach(function (row) {
                    var ipElement = row.querySelector('td:first-child');
                    var commentElement = row.querySelector('td:nth-child(2) input[type="text"]');
                    var inUseElement = row.querySelector('td:nth-child(3) input[type="checkbox"]');

                    if (ipElement && commentElement && inUseElement) {
                        var ip = ipElement.innerText;
                        var comment = commentElement.value;
                        var inUse = inUseElement.checked;

                        df.push({ subnet: subnet, ip_address: ip, comment: comment, in_use: inUse });
                    }
                });

                // Send the data to the backend (you can use AJAX, fetch, or any other method)
                var url = '/save';
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify(df));
            } else {
                console.log('Please select a subnet.');
            }
        }



        function handleCheckboxChange(checkbox, row) {
            if (checkbox.checked) {
                row.classList.add('checked-row');
            } else {
                row.classList.remove('checked-row');
            }
        }
    </script>
</body>
</html>
